<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<link rel="manifest" href="manifest.json" />
	<meta charset="utf-8">
	<title>cheller.info</title>
	<link rel="stylesheet" type="text/css" href="style.css">
	<meta name="apple-mobile-web-app-title" content="cheller.info">
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="grey" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0" />
	<meta name="msapplication-TileColor" content="#E3E3E3"/> 
	<meta name="msapplication-TileImage" content="launcher-icon-3x.png">	
</head>

<body>
	CHELLER.INFO
	<input type="button" onclick="if(!isSubscribed){subscribeUser();}" value="SUBSCRIBE" />
	 <section class="subscription-details js-subscription-details">
      <p>Once you've subscribed your user, you'd send their subscription to your
      server to store in a database so that when you want to send a message
      you can lookup the subscription and send a message to it.</p>
      <p>To simplify things for this code lab copy the following details
      into the <a href="https://web-push-codelab.appspot.com/">Push Companion
      Site</a> and it'll send a push message for you, using the application
      server keys on the site - so make sure they match.</p>
      <pre><code class="js-subscription-json"></code></pre>
    </section>
	
	<script src="app.js" async></script>
	<script>
	'use strict';
	const applicationServerPublicKey = 'BOwa9Vy8z4yRtGSqcF7GB3CfxWUgsuKVSFLQKUIjHF_-kP7lV5dfkVLDX-VFgW6nFKCVvXbMuouhjo143z-B6ic';
	let isSubscribed = false;
	let swRegistration = null;
	
	function urlB64ToUint8Array(base64String) {
	  const padding = '='.repeat((4 - base64String.length % 4) % 4);
	  const base64 = (base64String + padding)
		.replace(/\-/g, '+')
		.replace(/_/g, '/');

	  const rawData = window.atob(base64);
	  const outputArray = new Uint8Array(rawData.length);

	  for (let i = 0; i < rawData.length; ++i) {
		outputArray[i] = rawData.charCodeAt(i);
	  }
	  return outputArray;
	}
	
	function initialiseUI() {
	  // Set the initial subscription value
	  swRegistration.pushManager.getSubscription()
	  .then(function(subscription) {
		isSubscribed = !(subscription === null);

		if (isSubscribed) {
		  console.log('User IS subscribed.');
		} else {
		  console.log('User is NOT subscribed.');
		}
	  });
	}
	
	function updateSubscriptionOnServer(subscription) {
		// TODO: Send subscription to application server

		const subscriptionJson = document.querySelector('.js-subscription-json');
		const subscriptionDetails = document.querySelector('.js-subscription-details');

		if (subscription) {
			subscriptionJson.textContent = JSON.stringify(subscription);
			
		} else {
			
		}
	}
	
	function subscribeUser() {
		const applicationServerKey = urlB64ToUint8Array(applicationServerPublicKey);
		swRegistration.pushManager.subscribe({
			userVisibleOnly: true,
			applicationServerKey: applicationServerKey
		}).then(function(subscription) {
			console.log('User is subscribed.');
			updateSubscriptionOnServer(subscription);
			isSubscribed = true;
		}).catch(function(err) {
			console.log('Failed to subscribe the user: ', err);
		});
	}
	
	if ('serviceWorker' in navigator && 'PushManager' in window) {
		console.log('Service Worker and Push is supported');
		navigator.serviceWorker.register('/service-worker.js').then(function(swReg) {
		console.log('Service Worker is registered', swReg);
		swRegistration = swReg;
		initialiseUI();
	}).catch(function(error) {
		console.error('Service Worker Error', error);
	});
	} else {
		console.warn('Push messaging is not supported');
	}
	</script>
</body>
</html>